name: CI/CD Pipeline - Azure

on:
  push:
    branches:
      - master
      - dev
    tags:
      - 'v*'  # Triggers en tags que comiencen con 'v' (ej: v1.0.0)

env:
  REGISTRY: ghcr.io  
  IMAGE_OWNER: ${{ github.repository_owner }}
  IMAGE_REPO: ${{ github.event.repository.name }}

jobs:
  # ============================================================
  # 0. VALIDATE: Validar pertenencia de commits/tags
  # ============================================================
  validate:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.ctx.outputs.should_deploy }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - id: ctx
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            git branch -r --contains "$GITHUB_SHA" | grep -q "origin/master" || exit 1
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================
  # 1. BUILD: Compilar el proyecto Maven
  # ============================================================
  build:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Instalar dependencias
        run: mvn dependency:resolve

      - name: Compilar proyecto
        run: mvn clean compile

  # ============================================================
  # 2. TEST: Ejecutar tests unitarios e integraciÃ³n
  # ============================================================
  test:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Ejecutar tests
        run: mvn test

      - name: Generar reporte de cobertura (JaCoCo)
        run: mvn jacoco:report

      - name: Subir reportes de tests
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            target/surefire-reports/
            target/site/jacoco/

  # ============================================================
  # 3. STATIC ANALYSIS: AnÃ¡lisis estÃ¡tico de cÃ³digo
  # ============================================================
  static-analysis:
    needs: [validate, test]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Ejecutar SpotBugs (anÃ¡lisis estÃ¡tico)
        run: mvn spotbugs:check

      - name: Subir reportes de anÃ¡lisis
        uses: actions/upload-artifact@v4
        with:
          name: analysis-reports
          path: target/spotbugsXml.xml

  # ============================================================
  # 4. BUILD DOCKER IMAGE & PUSH
  # Solo en master (prod) y tags (prod versionado) - NO en dev
  # ============================================================
  publish:
    needs: [validate, static-analysis]
    runs-on: ubuntu-latest
    if: needs.validate.outputs.should_deploy == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}
      
      - name: Build & push to GHCR
        run: |
          REPO_LOWER=$(echo "${IMAGE_REPO}" | tr '[:upper:]' '[:lower:]')
          IMAGE_BASE=ghcr.io/${IMAGE_OWNER}/$REPO_LOWER
          SHA_SHORT=${GITHUB_SHA::8}
          
          # Determinar tags segÃºn el contexto
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # TAG â†’ version especÃ­fica + latest
            TAG_NAME=${GITHUB_REF#refs/tags/}
            echo "ðŸ“¦ Building PROD TAG: $TAG_NAME, $SHA_SHORT, latest"
            docker build -t "$IMAGE_BASE:$TAG_NAME" -t "$IMAGE_BASE:$SHA_SHORT" -t "$IMAGE_BASE:latest" .
            docker push "$IMAGE_BASE:$TAG_NAME"
            docker push "$IMAGE_BASE:$SHA_SHORT"
            docker push "$IMAGE_BASE:latest"
          elif [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            # MASTER â†’ sha + latest
            echo "ðŸ“¦ Building PROD MASTER: $SHA_SHORT, latest"
            docker build -t "$IMAGE_BASE:$SHA_SHORT" -t "$IMAGE_BASE:latest" .
            docker push "$IMAGE_BASE:$SHA_SHORT"
            docker push "$IMAGE_BASE:latest"
          fi

  
  # ============================================================
  # 5. DEPLOY CON TERRAFORM A AZURE (PRODUCCIÃ“N)
  # Solo en master (prod) y tags (prod versionado) - NO en dev
  # ============================================================
  terraform-deploy:
    needs: [validate, publish]
    runs-on: ubuntu-latest
    if: needs.validate.outputs.should_deploy == 'true'
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"

      - name: Autenticar en Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: RG exist
        run: |
          az group create -n devops-service-rg -l eastus \
            --tags environment=production managed-by=terraform

      - name: Get image ref
        id: img
        run: |
          OWNER_LOWER=$(echo "${{ env.IMAGE_OWNER }}" | tr '[:upper:]' '[:lower:]')
          REPO_LOWER=$(echo "${{ env.IMAGE_REPO }}" | tr '[:upper:]' '[:lower:]')
          
          # Seleccionar imagen segÃºn el contexto
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # TAG â†’ usar el tag especÃ­fico
            TAG_NAME=${GITHUB_REF#refs/tags/}
            IMAGE_REF="ghcr.io/${OWNER_LOWER}/${REPO_LOWER}:${TAG_NAME}"
            echo "ðŸš€ Deploying PROD with TAG: $TAG_NAME"
          elif [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            # MASTER â†’ usar latest
            IMAGE_REF="ghcr.io/${OWNER_LOWER}/${REPO_LOWER}:latest"
            echo "ðŸš€ Deploying PROD with MASTER: latest"
          fi
          
          echo "ref=$IMAGE_REF" >> $GITHUB_OUTPUT

      - name: Terraform Init
        run: terraform -chdir=terraform init -input=false

      - name: Terraform Validate
        run: terraform -chdir=terraform validate -no-color

      - name: Terraform Apply
        run: |
          terraform -chdir=terraform apply -auto-approve -input=false \
            -var="location=eastus" \
            -var="docker_image=${{ steps.img.outputs.ref }}" \
            -var="ghcr_username=cfidrobo97" \
            -var="ghcr_token=${{ secrets.GHCR_PAT }}" \
            -var="container_port=8080"

      - name: Show URL
        run: terraform -chdir=terraform output app_url

