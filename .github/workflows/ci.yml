name: CI & CD Pipeline

###############################################################################
#  DISPARADORES
###############################################################################
on:
  push:
    branches:
      - dev               # rama de desarrollo
    tags:
      - '*'               # cualquier tag → producción

###############################################################################
#  VARIABLES (ENV) COMUNES
###############################################################################
env:
  VALIDATION_BRANCH: main
  PIPELINE_STATUS_FILE: logs/pipeline_status.log
  REGISTRY: ghcr.io            # Usa GHCR; cámbialo si prefieres Docker Hub
  IMAGE_OWNER: ${{ github.repository_owner }}
  IMAGE_REPO:  ${{ github.event.repository.name }}
jobs:

  ###############################################################################
  #  1) VALIDATE
  ###############################################################################

  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate tag ancestry (only if ref is tag)
        id: tagcheck
        shell: bash
        run: |
          echo "🔍 Validating tag ancestry..."
          # ¿Es un tag?
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            # Traemos branch de validación
            git fetch origin $VALIDATION_BRANCH:$VALIDATION_BRANCH
            if git branch --contains ${{ github.sha }} | grep -q "$VALIDATION_BRANCH"; then
              echo "✅ Tag válido: commit presente en $VALIDATION_BRANCH"
            else
              echo "❌ Tag inválido: commit NO presente en $VALIDATION_BRANCH"
              exit 1
            fi
          else
            echo "✅ No es tag. Se asume rama dev."
          fi

###############################################################################
# 2) RESOLVE DEPENDENCIES
###############################################################################
  resolve-deps:
    name: Resolve Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Resolve Maven dependencies
        run: mvn dependency:resolve

  ###############################################################################
  # 3) TEST
  ###############################################################################
  test:
    name: Run Tests & Collect Coverage
    needs: [validate, resolve-deps]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Run unit tests
        run: mvn test

      - name: Generate JaCoCo report
        run: mvn jacoco:report

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: target/surefire-reports/

  ###############################################################################
  # 4) STATIC ANALYSIS
  ###############################################################################
  static-analysis:
    name: Static Code Analysis
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      #- name: Run Checkstyle
      #  run: mvn checkstyle:check

      - name: Run SpotBugs
        run: mvn spotbugs:check

      - name: Upload analysis reports
        uses: actions/upload-artifact@v4
        with:
          name: analysis-reports
          path: target/*-reports/

  ###############################################################################
  #  5) BUILD y PUSH
  ###############################################################################
  build_and_push:
    needs: static-analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Determine tag & namespace
        id: meta
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "namespace=produccion" >> $GITHUB_OUTPUT
            echo "image_tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            shortsha=$(echo "${{ github.sha }}" | cut -c1-8)
            echo "namespace=desarrollo"  >> $GITHUB_OUTPUT
            echo "image_tag=dev-${shortsha}" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Build & push Docker image
        run: |
          IMAGE_MAIN=${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.IMAGE_REPO }}:${{ steps.meta.outputs.image_tag }}
          IMAGE_LATEST=${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.IMAGE_REPO }}:latest
          
          docker build --build-arg PROFILE=${{ steps.meta.outputs.namespace }} \
            -t "$IMAGE_MAIN" -t "$IMAGE_LATEST" .
          
          docker push "$IMAGE_MAIN"
          docker push "$IMAGE_LATEST"
      - name: Save pipeline status
        run: |
          mkdir -p logs
          echo "push: success" >> $PIPELINE_STATUS_FILE
      - name: Upload pipeline log
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-logs
          path: logs/pipeline_status.log

  ###############################################################################
  #  6) NOTIFY  (siempre)
  ###############################################################################
  notify:
    runs-on: ubuntu-latest
    needs: build_and_push
    if: always()
    env:
      EMAIL_USER: ${{ secrets.EMAIL_USER }}
      EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
      SMTP_HOST: smtp.gmail.com
      SMTP_PORT: 587
    steps:
      - name: Get logs
        uses: actions/download-artifact@v4
        with:
          name: pipeline-logs
          path: logs/

      - name: Send e-mail report (simple stdout demo)
        env:
          EMAIL_USER:     ${{ secrets.EMAIL_USER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        shell: bash
        run: |
          echo ">> NOTIFY STAGE"
          echo "Repo:      ${{ github.repository }}"
          echo "Ref:       ${{ github.ref_name }}"
          echo "Commit:    ${{ github.sha }}"
          echo "========   Pipeline results   ========"
          cat logs/pipeline_status.log || echo "No status file"
          
          
          # Descomenta si realmente quieres mandar correo
          sudo apt-get update
          sudo apt-get install -y msmtp ca-certificates
          {
            echo "account default"
            echo "host smtp.gmail.com"
            echo "port 587"
            echo "auth on"
            echo "user $EMAIL_USER"
            echo "password $EMAIL_PASSWORD"
            echo "from $EMAIL_USER"
            echo "tls on"
            echo "tls_starttls on"
            echo "tls_trust_file /etc/ssl/certs/ca-certificates.crt"
          } > ~/.msmtprc
          chmod 600 ~/.msmtprc
          SUBJECT="🚀 Pipeline finalizado"
          BODY=$(cat logs/pipeline_status.log 2>/dev/null || echo "Sin log")
          echo -e "To: $EMAIL_USER\nSubject: $SUBJECT\n\n$BODY" | msmtp -t
